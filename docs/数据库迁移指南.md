# 数据库迁移指南

> 古玩字画智能对比系统
> 最后更新：2026-02-03

---

## 目录

- [快速开始](#快速开始)
- [Alembic 基础命令](#alembic-基础命令)
- [迁移工作流](#迁移工作流)
- [故障排查](#故障排查)

---

## 快速开始

### 方式 1: 使用初始化脚本（推荐）

```bash
cd backend

# 初始化数据库（创建表 + 种子数据）
python scripts/init_db.py

# 重新初始化（删除所有表后重建）
python scripts/init_db.py --drop-first
```

### 方式 2: 使用 Alembic 迁移

```bash
cd backend

# 1. 生成初始迁移
alembic revision --autogenerate -m "Initial migration"

# 2. 执行迁移
alembic upgrade head

# 3. 插入种子数据
python scripts/seed_data.py
```

---

## Alembic 基础命令

### 查看当前版本

```bash
alembic current
```

### 查看迁移历史

```bash
alembic history
```

### 生成新迁移

```bash
# 自动生成迁移（基于模型变更）
alembic revision --autogenerate -m "描述变更内容"

# 手动创建空白迁移
alembic revision -m "描述变更内容"
```

### 执行迁移

```bash
# 升级到最新版本
alembic upgrade head

# 升级到特定版本
alembic upgrade <revision_id>

# 降级一个版本
alembic downgrade -1

# 降级到特定版本
alembic downgrade <revision_id>
```

### 回滚迁移

```bash
# 回滚所有迁移
alembic downgrade base

# 回滚特定步数
alembic downgrade -3
```

---

## 迁移工作流

### 修改模型后的流程

1. **修改模型**

   在 `app/models/` 中修改或添加模型类

2. **生成迁移脚本**

   ```bash
   alembic revision --autogenerate -m "Add new field to User"
   ```

3. **检查生成的迁移**

   查看生成的迁移文件：
   ```
   alembic/versions/20240203_xxxxx_add_new_field_to_user.py
   ```

   确保生成的 SQL 符合预期

4. **执行迁移**

   ```bash
   alembic upgrade head
   ```

5. **验证**

   ```bash
   # 连接到数据库
   psql -U postgres -d antique_comparison

   # 检查表结构
   \d users
   ```

---

## 迁移最佳实践

### 1. 不要修改已执行的迁移

已执行的迁移文件不应修改，除非回滚后重新执行。

### 2. 保持迁移的可逆性

确保迁移的 `downgrade()` 方法正确实现：

```python
def upgrade() -> None:
    # 添加字段
    op.add_column('users', sa.Column('new_field', sa.String(), nullable=True))

def downgrade() -> None:
    # 删除字段
    op.drop_column('users', 'new_field')
```

### 3. 数据迁移

如果需要迁移数据，在迁移脚本中添加：

```python
from sqlalchemy.orm import Session

def upgrade() -> None:
    # 添加字段
    op.add_column('users', sa.Column('full_name', sa.String(), nullable=True))

    # 迁移数据
    session = Session(bind=op.get_bind())
    session.execute(
        "UPDATE users SET full_name = username"
    )
    session.commit()

def downgrade() -> None:
    op.drop_column('users', 'full_name')
```

### 4. 复杂迁移的测试

在开发环境先测试迁移：

```bash
# 创建测试数据库备份
pg_dump -U postgres antique_comparison > backup.sql

# 执行迁移
alembic upgrade head

# 验证结果
# ...

# 如有问题，恢复备份
psql -U postgres antique_comparison < backup.sql
```

---

## 种子数据

### 默认用户账号

| 用户名 | 密码 | 角色 | 说明 |
|--------|------|------|------|
| admin | admin123 | 管理员 | 系统管理员 |
| appraiser | appraiser123 | 鉴定师 | 文物鉴定师 |
| staff | staff123 | 工作人员 | 普通工作人员 |

### 插入种子数据

```bash
python scripts/seed_data.py
```

### 自定义种子数据

编辑 `scripts/seed_data.py` 添加自定义数据。

---

## 故障排查

### 问题 1: 迁移冲突

**错误**: `alembic.util.exc.CommandError: Target database is not up to date`

**解决方案**:
```bash
# 检查当前版本
alembic current

# 查看迁移历史
alembic history

# 手动标记版本
alembic stamp head
```

### 问题 2: 模型与数据库不一致

**错误**: 模型定义与实际表结构不匹配

**解决方案**:
```bash
# 方案 1: 重新生成迁移
alembic revision --autogenerate -m "Fix schema"

# 方案 2: 重建数据库（开发环境）
python scripts/init_db.py --drop-first
```

### 问题 3: 外键约束错误

**错误**: `ForeignKeyViolationError`

**解决方案**:
1. 确保相关表已创建
2. 检查外键引用的表和字段是否存在
3. 检查数据类型是否匹配

### 问题 4: 迁移脚本生成错误

**解决方案**:
1. 检查 `alembic/env.py` 中的 `target_metadata`
2. 确保所有模型都已导入
3. 运行 `alembic revision --autogenerate` 时使用 `-v` 查看详细日志

---

## 生产环境迁移

### 备份数据库

```bash
# 备份数据库
pg_dump -U postgres antique_comparison > backup_$(date +%Y%m%d).sql
```

### 在测试环境验证

```bash
# 在测试数据库执行迁移
DATABASE_URL=postgresql://user:pass@test-host/test_db alembic upgrade head
```

### 执行生产迁移

```bash
# 执行迁移
alembic upgrade head

# 检查状态
alembic current
```

### 回滚计划

准备回滚脚本：

```bash
# 回滚迁移
alembic downgrade -1

# 恢复备份
psql -U postgres antique_comparison < backup_YYYYMMDD.sql
```

---

## 数据库版本控制

### 迁移文件命名

```
alembic/versions/
├── 20240203_1200-1_initial_migration.py
├── 20240203_1400-2_add_user_preferences.py
├── 20240203_1600-3_add_artifact_categories.py
└── ...
```

### 版本管理最佳实践

1. 每个功能一个迁移文件
2. 使用清晰的描述
3. 不要合并迁移文件
4. 保持迁移的可逆性

---

## 参考资料

- [Alembic 官方文档](https://alembic.sqlalchemy.org/)
- [SQLAlchemy 文档](https://docs.sqlalchemy.org/)
- [PostgreSQL 文档](https://www.postgresql.org/docs/)

---

**文档结束**
