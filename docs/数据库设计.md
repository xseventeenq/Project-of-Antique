# 古玩字画智能对比系统 - 数据库设计文档

> 版本：v1.0
> 最后更新：2026-02-03

---

## 1. 数据库概述

### 1.1 数据库信息

| 属性 | 值 |
|------|-----|
| 数据库名 | `antique_comparison` |
| 字符集 | UTF-8 |
| 排序规则 | zh_CN.UTF-8 |
| 数据库类型 | PostgreSQL 15+ |

### 1.2 表关系概览

```
┌─────────────┐
│   users     │ 用户表
└──────┬──────┘
       │
       ├─────────────────────┐
       │                     │
┌──────▼──────┐      ┌───────▼────────┐
│borrow_records│      │return_records  │
└──────┬──────┘      └────────────────┘
       │
┌──────▼──────┐
│  artifacts  │ 文物表
└─────────────┘
```

---

## 2. 表结构设计

### 2.1 用户表 (users)

存储系统用户信息，支持三种角色。

#### 表结构

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| `id` | INTEGER | PRIMARY KEY, AUTOINCREMENT | 用户 ID |
| `username` | VARCHAR(50) | UNIQUE, NOT NULL | 用户名（登录账号） |
| `password_hash` | VARCHAR(255) | NOT NULL | 密码哈希（bcrypt） |
| `role` | VARCHAR(20) | NOT NULL | 角色：admin/appraiser/staff |
| `created_at` | TIMESTAMP | DEFAULT NOW() | 创建时间 |

#### 索引

- `idx_users_username`: username (UNIQUE)

#### 角色说明

| 角色 | 中文名称 | 权限 |
|------|----------|------|
| `admin` | 管理员 | 所有权限 |
| `appraiser` | 鉴定师 | 上传、查看、修改结论、导出 |
| `staff` | 普通工作人员 | 上传、查看 |

---

### 2.2 文物信息表 (artifacts)

存储文物的基本信息。

#### 表结构

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| `id` | INTEGER | PRIMARY KEY, AUTOINCREMENT | 文物内部 ID |
| `artifact_id` | VARCHAR(50) | UNIQUE, NOT NULL | 文物编号（业务主键） |
| `name` | VARCHAR(200) | NOT NULL | 文物名称 |
| `author` | VARCHAR(100) | NOT NULL | 作者 |
| `category` | VARCHAR(50) | NOT NULL | 类别（书法/绘画/扇面等） |
| `size` | VARCHAR(50) | | 尺寸 |
| `era` | VARCHAR(50) | | 年代 |
| `created_at` | TIMESTAMP | DEFAULT NOW() | 创建时间 |
| `updated_at` | TIMESTAMP | DEFAULT NOW() | 更新时间 |

#### 索引

- `idx_artifacts_artifact_id`: artifact_id (UNIQUE)
- `idx_artifacts_name`: name (用于搜索)
- `idx_artifacts_author`: author (用于筛选)
- `idx_artifacts_category`: category (用于筛选)

---

### 2.3 借出记录表 (borrow_records)

记录文物借出信息。

#### 表结构

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| `id` | INTEGER | PRIMARY KEY, AUTOINCREMENT | 借出记录 ID |
| `artifact_id` | INTEGER | FOREIGN KEY -> artifacts.id, NOT NULL | 关联的文物 ID |
| `borrow_photo_url` | VARCHAR(500) | NOT NULL | 借出照片路径 |
| `borrow_date` | DATE | NOT NULL | 借出日期 |
| `expected_return_date` | DATE | | 预计归还日期 |
| `status` | VARCHAR(20) | NOT NULL, DEFAULT 'borrowed' | 状态：borrowed/returned |
| `operator_id` | INTEGER | FOREIGN KEY -> users.id, NOT NULL | 操作员 ID |
| `created_at` | TIMESTAMP | DEFAULT NOW() | 创建时间 |

#### 外键关系

- `artifact_id` -> `artifacts.id` (ON DELETE CASCADE)
- `operator_id` -> `users.id` (ON DELETE RESTRICT)

#### 索引

- `idx_borrow_artifact_id`: artifact_id
- `idx_borrow_status`: status
- `idx_borrow_operator`: operator_id

#### 业务规则

- 一个文物可以有多条借出记录（历史记录）
- 同一时间只能有一条 `status='borrowed'` 的记录

---

### 2.4 归还记录表 (return_records)

记录文物归还和 AI 对比结果。

#### 表结构

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| `id` | INTEGER | PRIMARY KEY, AUTOINCREMENT | 归还记录 ID |
| `borrow_record_id` | INTEGER | FOREIGN KEY -> borrow_records.id, UNIQUE, NOT NULL | 关联的借出记录 ID |
| `return_photo_url` | VARCHAR(500) | NOT NULL | 归还照片路径 |
| `return_date` | DATE | NOT NULL | 归还日期 |
| `comparison_result` | JSONB | | AI 对比结果（详细） |
| `final_conclusion` | VARCHAR(20) | | 最终结论：authentic/suspicious/fake |
| `operator_id` | INTEGER | FOREIGN KEY -> users.id, NOT NULL | 操作员 ID |
| `created_at` | TIMESTAMP | DEFAULT NOW() | 创建时间 |

#### 外键关系

- `borrow_record_id` -> `borrow_records.id` (ON DELETE CASCADE)
- `operator_id` -> `users.id` (ON DELETE RESTRICT)

#### 索引

- `idx_return_borrow_record`: borrow_record_id (UNIQUE)
- `idx_return_conclusion`: final_conclusion

#### comparison_result JSON 结构

```json
{
  "conclusion": "authentic",        // 系统自动结论
  "confidence": 87,                   // 置信度 (0-100)
  "dimensions": {
    "seal": {
      "status": "normal",
      "score": 92,
      "description": "无明显差异",
      "annotation_url": "/uploads/annotations/seal_xxx.jpg"
    },
    "brushwork": {
      "status": "suspicious",
      "score": 78,
      "description": "墨色浓淡略有差异",
      "annotation_url": "/uploads/annotations/brushwork_xxx.jpg"
    },
    "paper": {
      "status": "normal",
      "score": 85,
      "description": "纹理特征一致",
      "annotation_url": "/uploads/annotations/paper_xxx.jpg"
    },
    "inscription": {
      "status": "normal",
      "score": 90,
      "description": "题跋内容一致",
      "annotation_url": "/uploads/annotations/inscription_xxx.jpg"
    },
    "composition": {
      "status": "normal",
      "score": 88,
      "description": "整体构图一致",
      "annotation_url": "/uploads/annotations/composition_xxx.jpg"
    },
    "watermark": {
      "status": "normal",
      "score": 95,
      "description": "防伪标记一致",
      "annotation_url": "/uploads/annotations/watermark_xxx.jpg"
    }
  }
}
```

#### final_conclusion 枚举值

| 值 | 中文名称 | 说明 |
|----|----------|------|
| `authentic` | 确认为真品 | 系统或鉴定师确认为真品 |
| `suspicious` | 存疑 | 需要进一步人工复核 |
| `fake` | 确认为仿品 | 系统或鉴定师确认为仿品 |

---

## 3. ER 图

```
┌─────────────────────────────────────┐
│              users                  │
├─────────────────────────────────────┤
│ PK │ id               INTEGER       │
│    │ username         VARCHAR(50)   │
│    │ password_hash    VARCHAR(255)  │
│    │ role             VARCHAR(20)   │
│    │ created_at       TIMESTAMP     │
└───────┬─────────────────────────────┘
        │
        │ 1:N
        ├──────────────────────┬──────────────────┐
        │                      │
┌───────▼──────────┐    ┌──────▼───────────────────┐
│ borrow_records   │    │   return_records         │
├──────────────────┤    ├──────────────────────────┤
│ PK │ id          │    │ PK │ id                 │
│ FK │ artifact_id │◄───┤ FK │ borrow_record_id   │
│    │ borrow_photo│    │    │ return_photo       │
│    │ borrow_date │    │    │ return_date        │
│    │ status      │    │    │ comparison_result  │
│ FK │ operator_id │    │    │ final_conclusion   │
│    │ created_at  │    │ FK │ operator_id        │
└──────┬───────────┘    │    │ created_at         │
       │                └──────────────────────────┘
       │
       │ N:1
       │
┌──────▼──────────┐
│   artifacts     │
├─────────────────┤
│ PK │ id         │
│    │artifact_id │
│    │ name       │
│    │ author     │
│    │ category   │
│    │ size       │
│    │ era        │
│    │ created_at │
│    │ updated_at │
└─────────────────┘
```

---

## 4. 数据字典

### 4.1 枚举类型

#### user_role

| 值 | 说明 |
|----|------|
| `admin` | 管理员 |
| `appraiser` | 鉴定师 |
| `staff` | 普通工作人员 |

#### borrow_status

| 值 | 说明 |
|----|------|
| `borrowed` | 已借出 |
| `returned` | 已归还 |

#### conclusion_type

| 值 | 说明 |
|----|------|
| `authentic` | 确认为真品 |
| `suspicious` | 存疑 |
| `fake` | 确认为仿品 |

---

## 5. 数据库约束

### 5.1 主键约束

所有表都有自增主键 `id`。

### 5.2 外键约束

| 外键 | 来源表 | 目标表 | 级联规则 |
|------|--------|--------|----------|
| `artifact_id` | borrow_records | artifacts | CASCADE |
| `operator_id` | borrow_records | users | RESTRICT |
| `borrow_record_id` | return_records | borrow_records | CASCADE |
| `operator_id` | return_records | users | RESTRICT |

### 5.3 唯一性约束

- `users.username`
- `artifacts.artifact_id`
- `return_records.borrow_record_id`

### 5.4 非空约束

关键字段设置 `NOT NULL` 约束。

### 5.5 检查约束

```sql
-- 角色检查
CHECK (role IN ('admin', 'appraiser', 'staff'))

-- 状态检查
CHECK (status IN ('borrowed', 'returned'))

-- 结论检查
CHECK (final_conclusion IN ('authentic', 'suspicious', 'fake'))
```

---

## 6. 性能优化

### 6.1 索引策略

- 业务查询字段（artifact_id, username）创建唯一索引
- 外键字段创建普通索引
- 常用搜索字段（name, author, category）创建索引

### 6.2 查询优化

- 使用 JSONB 存储对比结果，支持 JSON 查询
- 分页查询使用 LIMIT/OFFSET
- 复杂查询使用视图简化

---

## 7. 数据备份与恢复

### 7.1 备份策略

- 每日凌晨自动备份
- 保留最近 30 天备份
- 备份文件命名：`backup_YYYYMMDD.sql`

### 7.2 恢复流程

```bash
# 恢复备份
psql -U postgres -d antique_comparison < backup_YYYYMMDD.sql
```

---

## 8. 数据迁移计划

### 8.1 初始迁移

创建所有表和基础索引。

### 8.2 种子数据

插入默认管理员账户：

```sql
INSERT INTO users (username, password_hash, role)
VALUES ('admin', '$2b$12$...', 'admin');
```

### 8.3 版本控制

使用 Alembic 进行数据库版本管理。

---

**文档结束**