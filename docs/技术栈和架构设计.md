# 古玩字画智能对比系统 - 技术栈和架构设计

> 文档版本：v1.0
> 创建日期：2026-02-03
> 最后更新：2026-02-03

---

## 1. 技术栈选型

### 1.1 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **Vue.js** | 3.4+ | 渐进式 JavaScript 框架 |
| **Vite** | 5.0+ | 前端构建工具 |
| **Element Plus** | 2.5+ | Vue 3 UI 组件库 |
| **Vue Router** | 4.2+ | 官方路由管理器 |
| **Pinia** | 2.1+ | Vue 官方状态管理 |
| **Axios** | 1.6+ | HTTP 客户端 |
| **Fabric.js** | 6.0+ | 图片标注和画布操作 |
| **ESLint** | 8.57+ | 代码检查工具 |
| **Prettier** | 3.2+ | 代码格式化工具 |

**选型理由**：
- Vue 3：Composition API 提供更好的代码组织和 TypeScript 支持
- Element Plus：丰富的企业级组件，降低开发成本
- Fabric.js：强大的 Canvas 操作库，适合图片标注需求

### 1.2 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **Python** | 3.10+ | 主要开发语言 |
| **FastAPI** | 0.110+ | 现代化 Web 框架 |
| **SQLAlchemy** | 2.0+ | ORM 框架 |
| **Alembic** | 1.13+ | 数据库迁移工具 |
| **Pydantic** | 2.6+ | 数据验证和解析 |
| **PostgreSQL** | 15+ | 关系型数据库 |
| **Uvicorn** | 0.27+ | ASGI 服务器 |
| **python-jose** | 3.3+ | JWT 认证 |
| **passlib** | 1.7+ | 密码哈希 |
| **pytest** | 8.0+ | 测试框架 |

**选型理由**：
- FastAPI：高性能、自动生成 API 文档、原生异步支持
- SQLAlchemy：成熟的 Python ORM，支持复杂查询
- PostgreSQL：支持 JSON 类型，适合存储对比结果

### 1.3 AI 服务技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **OpenCV** | 4.9+ | 图像处理 |
| **Pillow** | 10.2+ | 图像操作 |
| **NumPy** | 1.26+ | 数值计算 |
| **OpenAI Vision API** | - | MVP 阶段图像对比（可选） |
| **torch** | 2.2+ | 深度学习框架（可选） |
| **transformers** | - | Hugging Face 模型（可选） |

**选型理由**：
- MVP 阶段使用 OpenAI Vision API 快速验证可行性
- 后续可替换为开源模型（CLIP、ResNet 等）

### 1.4 部署技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **Docker** | 24+ | 容器化 |
| **Docker Compose** | 2.24+ | 多容器编排 |
| **Nginx** | 1.25+ | 反向代理和静态文件服务 |
| **PostgreSQL** | 15+ | 数据库容器 |

---

## 2. 项目目录结构

```
Project of Antique/
├── backend/                    # 后端项目
│   ├── app/
│   │   ├── api/               # API 路由
│   │   │   ├── __init__.py
│   │   │   ├── auth.py        # 认证相关 API
│   │   │   ├── artifacts.py   # 文物管理 API
│   │   │   ├── borrow.py      # 借出记录 API
│   │   │   ├── return.py      # 归还记录 API
│   │   │   └── admin.py       # 系统管理 API
│   │   ├── models/            # 数据模型
│   │   │   ├── __init__.py
│   │   │   ├── user.py
│   │   │   ├── artifact.py
│   │   │   ├── borrow_record.py
│   │   │   └── return_record.py
│   │   ├── schemas/           # Pydantic schemas
│   │   │   ├── __init__.py
│   │   │   ├── user.py
│   │   │   ├── artifact.py
│   │   │   ├── borrow.py
│   │   │   └── return.py
│   │   ├── services/          # 业务逻辑
│   │   │   ├── __init__.py
│   │   │   ├── auth_service.py
│   │   │   ├── artifact_service.py
│   │   │   └── comparison_service.py
│   │   ├── core/              # 核心配置
│   │   │   ├── __init__.py
│   │   │   ├── config.py      # 配置文件
│   │   │   ├── database.py    # 数据库配置
│   │   │   └── security.py    # 安全相关（JWT、密码）
│   │   └── utils/             # 工具函数
│   │       ├── __init__.py
│   │       ├── file.py        # 文件操作
│   │       └── image.py       # 图像处理
│   ├── tests/                 # 测试文件
│   ├── alembic/               # 数据库迁移
│   │   └── versions/
│   ├── main.py                # FastAPI 应用入口
│   ├── requirements.txt       # Python 依赖
│   └── pyproject.toml         # 项目配置
│
├── frontend/                   # 前端项目
│   ├── src/
│   │   ├── views/             # 页面组件
│   │   │   ├── Login.vue
│   │   │   ├── Home.vue
│   │   │   ├── Borrow.vue
│   │   │   ├── Return.vue
│   │   │   ├── BorrowRecords.vue
│   │   │   ├── ReturnRecords.vue
│   │   │   ├── ArtifactDetail.vue
│   │   │   └── Admin.vue
│   │   ├── components/        # 通用组件
│   │   │   ├── Layout.vue
│   │   │   ├── ImageUpload.vue
│   │   │   ├── ImageComparison.vue
│   │   │   └── ...
│   │   ├── api/               # API 调用
│   │   │   ├── index.ts
│   │   │   ├── auth.ts
│   │   │   ├── artifact.ts
│   │   │   └── ...
│   │   ├── stores/            # Pinia stores
│   │   │   ├── auth.ts
│   │   │   ├── artifact.ts
│   │   │   └── ...
│   │   ├── router/            # 路由配置
│   │   │   └── index.ts
│   │   ├── utils/             # 工具函数
│   │   │   └── ...
│   │   ├── assets/            # 静态资源
│   │   └── main.ts            # 应用入口
│   ├── public/
│   ├── index.html
│   ├── vite.config.ts
│   ├── package.json
│   └── tsconfig.json
│
├── ai_service/                 # AI 对比服务
│   ├── services/               # AI 服务模块
│   │   ├── base.py            # 基础服务类
│   │   ├── overall.py         # 整体相似度
│   │   ├── seal.py            # 印章检测
│   │   ├── brushwork.py       # 笔触分析
│   │   └── ...
│   ├── models/                 # 模型文件目录
│   ├── utils/                  # 工具函数
│   └── api.py                  # 服务接口
│
├── uploads/                    # 上传文件目录
│   └── .gitkeep
│
├── docs/                       # 文档
│   ├── 古玩字画智能对比系统PRD.md
│   └── todo.md
│
├── .gitignore
├── .env.example
├── docker-compose.yml
└── README.md
```

---

## 3. 代码规范

### 3.1 Python 代码规范（PEP 8）

**命名规范**：
- 类名：大驼峰 `class UserService:`
- 函数名：小写下划线 `def get_user():`
- 变量名：小写下划线 `user_id`
- 常量：大写下划线 `MAX_UPLOAD_SIZE`
- 私有成员：单下划线前缀 `_internal_func`

**导入顺序**：
1. 标准库
2. 第三方库
3. 本地模块
```python
import os
from datetime import datetime

from fastapi import Depends
from sqlalchemy.orm import Session

from app.models import User
from app.core.config import settings
```

**文档字符串**：使用 Google 风格
```python
def get_user(user_id: int) -> User:
    """根据用户 ID 获取用户信息。

    Args:
        user_id: 用户 ID

    Returns:
        用户对象

    Raises:
        UserNotFoundError: 用户不存在时抛出
    """
    pass
```

### 3.2 JavaScript/Vue 代码规范

**命名规范**：
- 组件名：大驼峰 `ImageUpload.vue`
- 函数名：小驼峰 `getUserById()`
- 常量：大写下划线 `MAX_SIZE`
- 组合式函数：use 前缀 `useAuth()`

**组件结构**：
```vue
<script setup lang="ts">
// 1. 导入
import { ref, computed } from 'vue'

// 2. Props 定义
interface Props {
  modelValue: string
}
const props = defineProps<Props>()

// 3. Emits 定义
const emit = defineEmits<{
  'update:modelValue': [value: string]
}>()

// 4. 响应式状态
const count = ref(0)

// 5. 计算属性
const double = computed(() => count.value * 2)

// 6. 方法
function increment() {
  count.value++
}

// 7. 生命周期
onMounted(() => {
  console.log('mounted')
})
</script>

<template>
  <div>{{ count }}</div>
</template>

<style scoped>
/* 样式 */
</style>
```

### 3.3 Git 提交规范

使用 Conventional Commits 格式：

```
<type>(<scope>): <subject>

<body>

<footer>
```

**类型（type）**：
- `feat`: 新功能
- `fix`: Bug 修复
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 构建/工具链相关

**示例**：
```
feat(auth): implement JWT authentication

- Add login API endpoint
- Add token generation and validation
- Add protected route decorator

Closes #123
```

---

## 4. 分支策略

### 4.1 主要分支

| 分支 | 用途 | 稳定性 |
|------|------|--------|
| `main` | 生产环境代码 | 最稳定 |
| `develop` | 开发集成分支 | 相对稳定 |
| `feature/*` | 功能开发分支 | 不稳定 |

### 4.2 分支工作流

```
main (生产)
  ↑
  └── merge (release)
       ↑
       develop (开发)
         ↑
         ├── feature/auth (功能分支)
         ├── feature/borrow
         └── feature/ai-comparison
```

**工作流程**：
1. 从 `develop` 创建功能分支 `feature/xxx`
2. 在功能分支上开发和测试
3. 提交 Pull Request 到 `develop`
4. 代码审查通过后合并
5. 定期从 `develop` 发布到 `main`

---

## 5. 架构设计原则

### 5.1 前后端分离

- 前端：Vue 3 SPA，负责 UI 和用户交互
- 后端：FastAPI RESTful API，负责业务逻辑
- 通信：HTTP + JSON

### 5.2 分层架构

```
┌─────────────────────────────┐
│      前端 (Vue 3)           │
├─────────────────────────────┤
│   API 路由层 (FastAPI)      │
├─────────────────────────────┤
│   服务层 (Business Logic)   │
├─────────────────────────────┤
│   数据访问层 (SQLAlchemy)   │
├─────────────────────────────┤
│   数据存储 (PostgreSQL)     │
└─────────────────────────────┘
```

### 5.3 RESTful API 设计

| 方法 | 路径 | 描述 |
|------|------|------|
| POST | /api/auth/login | 用户登录 |
| GET | /api/artifacts | 获取文物列表 |
| POST | /api/artifacts | 创建文物 |
| GET | /api/artifacts/:id | 获取文物详情 |
| PUT | /api/artifacts/:id | 更新文物 |
| DELETE | /api/artifacts/:id | 删除文物 |

### 5.4 数据库设计原则

- 使用外键维护关系完整性
- 添加索引优化查询性能
- 使用 JSON 存储非结构化数据（如对比结果）
- 软删除重要数据（保留历史）

---

## 6. 安全设计

### 6.1 认证和授权

- JWT Token 认证
- 基于角色的访问控制（RBAC）
- 密码使用 bcrypt 哈希
- Token 过期时间：24 小时

### 6.2 数据安全

- 文件上传类型验证
- 文件大小限制（10MB）
- SQL 注入防护（ORM 参数化查询）
- XSS 防护（前端转义）
- CORS 配置

### 6.3 备份策略

- 每日凌晨自动备份
- 保留最近 30 天备份
- 支持手动备份和恢复

---

## 7. 性能优化

### 7.1 前端优化

- 路由懒加载
- 图片懒加载
- 组件按需导入
- Vite 打包优化

### 7.2 后端优化

- 异步任务处理（AI 对比）
- 数据库连接池
- 查询结果缓存（可选 Redis）
- 分页查询

### 7.3 存储优化

- 上传图片压缩
- 标注图片静态存储
- 数据库定期清理（可选）

---

**文档结束**
